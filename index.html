<!DOCTYPE html>
<html>
<head>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body {
      background: #f4f7fa;
      font-family: 'Montserrat', Arial, sans-serif;
      margin: 0;
      min-height: 100vh;
      color: #222;
    }
    .main-card {
      background: #fff;
      max-width: 700px;
      margin: 40px auto 32px auto;
      padding: 36px 32px 32px 32px;
      border-radius: 18px;
      box-shadow: 0 4px 24px rgba(60,40,20,0.10), 0 1.5px 4px rgba(60,40,20,0.04);
      border: 1px solid #e0e6ed;
    }
    h2, h3, h4 {
      font-family: 'Montserrat', Arial, sans-serif;
      color: #222;
      margin-top: 0;
      margin-bottom: 0.7em;
    }
    h2 {
      font-size: 2em;
      font-weight: 700;
      letter-spacing: 0.01em;
    }
    h3 {
      font-size: 1.2em;
      font-weight: 700;
      letter-spacing: 0.02em;
    }
    textarea, input[type="text"] {
      width: 100%;
      font-size: 1.08em;
      padding: 12px 14px;
      border: 1px solid #b5c6d6;
      border-radius: 8px;
      background: #f8fafc;
      margin-bottom: 18px;
      font-family: 'Montserrat', Arial, sans-serif;
      box-sizing: border-box;
      transition: border 0.2s;
    }
    textarea:focus, input[type="text"]:focus {
      border: 1.5px solid #444;
      outline: none;
      background: #fff;
    }
    button {
      background: #ff7a00;
      color: #fff;
      font-family: 'Montserrat', Arial, sans-serif;
      font-size: 1em;
      padding: 10px 22px;
      border: none;
      border-radius: 7px;
      margin: 6px 0 18px 0;
      box-shadow: 0 2px 8px rgba(60,40,20,0.07);
      cursor: pointer;
      transition: background 0.2s, box-shadow 0.2s;
    }
    button:hover, button:focus {
      background: #e55d00;
      box-shadow: 0 4px 16px rgba(60,40,20,0.13);
    }
    #output, #authStatus {
      color: #222;
      font-size: 1em;
      margin-bottom: 18px;
    }
    #resultsSection {
      display: none;
    }
    .main-card ul {
      padding-left: 1.2em;
      margin-bottom: 1.2em;
    }
    .main-card li {
      margin-bottom: 0.5em;
    }
    table {
      background: #f8fafc;
      border-radius: 8px;
      overflow: hidden;
    }
    th {
      background: #f4f7fa;
      color: #222;
    }
    td, th {
      border: none;
    }
  </style>
  <!-- Add mammoth.js for .docx processing -->
  <script src="https://unpkg.com/mammoth/mammoth.browser.min.js"></script>
  <title>Writing Analyzer</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    textarea { width: 100%; height: 200px; }
  </style>
</head>
<body>

  <!-- Google API client library -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script src="https://apis.google.com/js/api.js"></script>

  <div class="main-card">
    <h2>Instructions</h2>
    <p>Upload your manuscript using either a .docx file or GoogleDocs below.</p>
    <ul>
      <li>For GoogleDocs, you will need to sign in with your Google account and authorize access to your documents.</li>
      <li>Once signed in, paste the link to your GoogleDoc in the field provided and click "Submit Google Doc."</li>
      <li>For docx files, click "Upload .docx" after selecting your file.</li>
      <li>Your text will appear in the text area above for analysis.</li>
      <li>Click "Analyze" to see readability scores and top used words.</li>
    </ul>
    <p>Note: No data is stored or shared; all processing occurs in your browser.</p>

    <h2>Writing Analyzer</h2>
    <textarea id="inputText" placeholder="Paste your writing here..."></textarea><br><br>
    <button onclick="analyze()">Analyze</button>

    <h3>Or upload a .docx file</h3>
    <input type="file" id="docxInput" accept=".docx" />
    <button onclick="handleDocxUpload()">Upload .docx</button>
    <br><br>

    <h3>Google Authentication</h3>
    <button id="googleSignIn" onclick="handleGoogleSignIn()">Sign in with Google</button>
    <div id="authStatus"></div>

    <h3>Or enter a Google Doc link</h3>
    <input type="text" id="gdocUrl" placeholder="Paste Google Doc URL here" size="50" />
    <button onclick="handleGoogleDoc()">Submit Google Doc</button>
    <br><br>
    <div id="output"></div>

    <div id="resultsSection">
      <h2>Results</h2>
      <h3>Readability</h3>
      <p id="grade"></p>
      <h4>Flesch-Kincaid Grade Level</h4>
      <p>Assesses the approximate reading grade level of a text, based on average sentence length and word complexity.</p>
      <h4>Coleman-Liau Index</h4>
      <p>An alternative formula that focuses on word length to assess grade level.</p>
      <h4>Tips</h4>
      <p>Aim for a grade level appropriate to your audience. For general audiences, a grade level of 7-8 is often recommended.</p>

      <h3>Top Used Words</h3>
      <p id="words"></p>
      <h4>Tips</h4>
      <p>Certain words will probably appear multiple times per page--especially articles and pronouns--but, pay attention if:</p>
      <ul>
        <li>You see verbs such as 'is' and 'was' more than once a page because it suggests passive voice and weak verbs</li>
        <li>You find words like 'just,' 'that,' 'still,' 'begin,' and 'start'--these are filler words to cull</li>
        <li>You see verbs used repeatedly where you could employ synonyms</li>
      </ul>
      <p>Consider using the 'Control F' function to highlight these words in your text to check if:</p>
      <ul>
        <li>Any word appears multiple times in a single sentence</li>
        <li>A noun, adjective, or verb appears multiple times in a single paragraph or page</li>
        <li>Can you rephrase sentences to avoid repeating the same word?</li>
      </ul>
    </div>
  </div>

  <script>
    // Google API config
    const CLIENT_ID = '709067795013-ij09egf2e0a12d1467mvhi5a35fbdi8i.apps.googleusercontent.com'; 
    const API_KEY = '';
    const DISCOVERY_DOC = 'https://docs.googleapis.com/$discovery/rest?version=v1';
    const SCOPES = 'https://www.googleapis.com/auth/documents.readonly';

    let tokenClient;
    let gapiInited = false;
    let gisInited = false;

    function gapiLoaded() {
      gapi.load('client', initializeGapiClient);
    }

    async function initializeGapiClient() {
      await gapi.client.init({
        apiKey: API_KEY,
        discoveryDocs: [DISCOVERY_DOC],
      });
      gapiInited = true;
      maybeEnableButtons();
    }

    function gisLoaded() {
      tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: SCOPES,
        callback: '',
      });
      gisInited = true;
      maybeEnableButtons();
    }

    function maybeEnableButtons() {
      if (gapiInited && gisInited) {
        document.getElementById('googleSignIn').disabled = false;
      }
    }

    window.onload = function() {
      document.getElementById('googleSignIn').disabled = true;
      // Load Google API libraries
      window.gapiLoaded = gapiLoaded;
      window.gisLoaded = gisLoaded;
      // Load gapi and gis
      const gapiScript = document.createElement('script');
      gapiScript.src = 'https://apis.google.com/js/api.js?onload=gapiLoaded';
      document.body.appendChild(gapiScript);
      const gisScript = document.createElement('script');
      gisScript.src = 'https://accounts.google.com/gsi/client';
      gisScript.onload = gisLoaded;
      document.body.appendChild(gisScript);
    };

    function handleGoogleSignIn() {
      tokenClient.callback = async (resp) => {
        if (resp.error !== undefined) {
          throw resp;
        }
        document.getElementById('authStatus').innerText = 'Signed in!';
        window.gapiAccessToken = resp.access_token;
      };
      tokenClient.requestAccessToken({prompt: 'consent'});
    }
    function analyze() {
  // Show the results section
  document.getElementById('resultsSection').style.display = 'block';
      const text = document.getElementById("inputText").value;

      // Basic word count
      const words = text.toLowerCase().match(/\b[a-z']+\b/g) || [];
      const freq = {};
      words.forEach(w => freq[w] = (freq[w] || 0) + 1);

  // Sort by frequency and get top 50
  const topWords = Object.entries(freq).sort((a, b) => b[1] - a[1]).slice(0, 50);

      // Flesch-Kincaid Grade Level
      function countSyllables(word) {
        word = word.toLowerCase();
        if(word.length <= 3) { return 1; }
        word = word.replace(/(?:[^laeiouy]es|ed|[^laeiouy]e)$/, '');
        word = word.replace(/^y/, '');
        const matches = word.match(/[aeiouy]{1,2}/g);
        return matches ? matches.length : 1;
      }
      const sentences = text.split(/[.!?]+/).filter(s => s.trim().length > 0).length;
      const wordsArr = text.match(/\b\w+\b/g) || [];
      const syllableCount = wordsArr.reduce((acc, w) => acc + countSyllables(w), 0);
      // Flesch-Kincaid Grade Level formula
      // 0.39 * (words/sentences) + 11.8 * (syllables/words) - 15.59
      const fkGrade = sentences > 0 && wordsArr.length > 0
        ? 0.39 * (wordsArr.length / sentences) + 11.8 * (syllableCount / wordsArr.length) - 15.59
        : 0;

      // Coleman-Liau Index
      // L = average number of letters per 100 words
      // S = average number of sentences per 100 words
      // CLI = 0.0588 * L - 0.296 * S - 15.8
      let letterCount = 0;
      wordsArr.forEach(w => {
        letterCount += w.replace(/[^a-zA-Z]/g, '').length;
      });
      const wordCount = wordsArr.length;
      const L = wordCount > 0 ? (letterCount / wordCount) * 100 : 0;
      const S = wordCount > 0 ? (sentences / wordCount) * 100 : 0;
      const cli = wordCount > 0 ? 0.0588 * L - 0.296 * S - 15.8 : 0;

      document.getElementById("grade").innerText = `Flesch-Kincaid: ${fkGrade.toFixed(1)} | Coleman-Liau: ${cli.toFixed(1)}`;

      // Table of top 50 words with average per 250 words
      let tableHtml = '<table style="border-collapse:collapse;margin-top:10px;width:100%"><thead><tr>' +
        '<th style="border-bottom:1px solid #bfa77a;text-align:left;padding:4px 8px;">Word</th>' +
        '<th style="border-bottom:1px solid #bfa77a;text-align:right;padding:4px 8px;">Count</th>' +
        '<th style="border-bottom:1px solid #bfa77a;text-align:right;padding:4px 8px;">Avg per 250 words</th>' +
        '</tr></thead><tbody>';
      topWords.forEach(([word, count]) => {
        const avg = wordCount > 0 ? (count / wordCount) * 250 : 0;
        tableHtml += `<tr><td style="padding:4px 8px;">${word}</td><td style="text-align:right;padding:4px 8px;">${count}</td><td style="text-align:right;padding:4px 8px;">${avg.toFixed(2)}</td></tr>`;
      });
      tableHtml += '</tbody></table>';
      document.getElementById("words").innerHTML = tableHtml;
    }

    function handleDocxUpload() {
      const input = document.getElementById('docxInput');
      const file = input.files[0];
      if (!file) {
        alert('Please select a .docx file.');
        return;
      }
      // Read file as ArrayBuffer and process with mammoth.js
      const reader = new FileReader();
      reader.onload = function(e) {
        mammoth.extractRawText({arrayBuffer: e.target.result})
          .then(function(result) {
            document.getElementById('output').innerText = 'File loaded: ' + file.name;
            document.getElementById('inputText').value = result.value;
          })
          .catch(function(err) {
            document.getElementById('output').innerText = 'Error processing .docx: ' + err.message;
          });
      };
      reader.readAsArrayBuffer(file);
    }

    function handleGoogleDoc() {
      const url = document.getElementById('gdocUrl').value.trim();
      if (!url) {
        alert('Please enter a Google Doc URL.');
        return;
      }
      // Extract the document ID from the URL
      const match = url.match(/\/d\/([a-zA-Z0-9-_]+)/);
      const docId = match ? match[1] : null;
      if (!docId) {
        document.getElementById('output').innerText = 'Invalid Google Doc URL.';
        return;
      }
      // Check if user is authenticated
      if (!window.gapiAccessToken) {
        document.getElementById('output').innerText = 'Please sign in with Google first.';
        return;
      }
      document.getElementById('output').innerText = 'Fetching Google Doc content...';
      // Fetch the document content using Google Docs API
      gapi.client.docs.documents.get({documentId: docId}).then(function(response) {
        // Extract plain text from the document body
        const body = response.result.body;
        let text = '';
        if (body && body.content) {
          body.content.forEach(element => {
            if (element.paragraph && element.paragraph.elements) {
              element.paragraph.elements.forEach(e => {
                if (e.textRun && e.textRun.content) {
                  text += e.textRun.content;
                }
              });
            }
          });
        }
        document.getElementById('output').innerText = 'Google Doc loaded!';
        document.getElementById('inputText').value = text;
      }, function(error) {
        document.getElementById('output').innerText = 'Error fetching Google Doc: ' + error.result.error.message;
      });
    }
  </script>
</body>
</html>
